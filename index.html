<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Al Bayan | ‡¶Ü‡¶∞‡¶¨‡ßÄ ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡¶ø‡¶ï ‡¶¨‡¶á ‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶‡¶ï</title>
    <!-- Load Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <!-- Load Tesseract.js for OCR -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <!-- Load Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Load Custom Fonts (Hind Siliguri for Bangla, Amiri for Arabic) -->
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* Custom Tailwind Configuration (Setting up primary colors for reuse) */
        :root {
            --color-primary: #2E8B57; /* Sea Green / Emerald 600 */
            --color-gold: #D4AF37; /* Goldenrod */
        }

        /* Custom Fonts for Bangla and Arabic */
        body {
            font-family: 'Hind Siliguri', sans-serif;
        }
        .arabic-text {
            font-family: 'Amiri', serif;
            text-align: right;
            direction: rtl;
        }
        .bangla-text {
            font-family: 'Hind Siliguri', sans-serif;
            text-align: justify;
        }

        /* Recreating the theme variables using CSS custom properties for JS toggle */
        [data-theme="dark"] .bg-base { background: #1A202C !important; }
        [data-theme="dark"] .text-base { color: #F7FAFC !important; }
        [data-theme="dark"] .bg-card { background: #2D3748 !important; }
        [data-theme="dark"] .text-muted { color: #CBD5E0 !important; }
        [data-theme="dark"] .border-light { border-color: #4A5568 !important; }
        [data-theme="dark"] .bg-upload { background: linear-gradient(135deg, #1e3a1e 0%, #2d4a2d 100%) !important; }
        [data-theme="dark"] .bg-warning { background: #443300 !important; color: #ffeb99 !important; }
        [data-theme="dark"] .bg-success { background: #155724 !important; color: #d4edda !important; }

        /* Custom Styles for Effects and Overrides */
        .header-bg {
            background: linear-gradient(135deg, var(--color-primary) 0%, #1a5c3a 100%);
        }
        .logo-gradient {
            background: linear-gradient(135deg, var(--color-gold) 0%, #B8860B 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
        }
        .btn-primary-gradient {
            background: linear-gradient(135deg, var(--color-primary) 0%, #1a5c3a 100%);
        }
        .btn-gold-gradient {
            background: linear-gradient(135deg, var(--color-gold) 0%, #B8860B 100%);
        }
        .btn-danger-gradient {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }
        .btn-secondary-gradient {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        }
        .progress-gradient {
             background: linear-gradient(135deg, var(--color-primary) 0%, #1a5c3a 100%);
        }
        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .tts-active {
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
        }

        .notification {
            z-index: 2000;
        }
    </style>

    <script>
        // Set the path for PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
    </script>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen transition-all duration-300 bg-base">
    <!-- Notification Container -->
    <div id="notificationContainer" class="fixed top-5 right-5 space-y-2 notification"></div>

    <div class="container mx-auto p-5 max-w-7xl">
        <!-- Header -->
        <header class="header-bg rounded-3xl p-10 mb-8 relative overflow-hidden shadow-2xl">
            <!-- Theme Toggle -->
            <div class="absolute top-5 right-5 z-10">
                <label class="switch relative inline-block w-16 h-8">
                    <input type="checkbox" id="themeToggle" class="opacity-0 w-0 h-0">
                    <span class="slider absolute cursor-pointer top-0 left-0 right-0 bottom-0 bg-blue-500 transition-all duration-300 rounded-full before:absolute before:content-[''] before:h-6 before:w-6 before:left-1 before:bottom-1 before:bg-white before:transition-all before:duration-300 before:rounded-full"></span>
                </label>
            </div>
            <script>
                // Switch styling implementation in JS for simplicity
                const themeToggle = document.getElementById('themeToggle');
                themeToggle.addEventListener('change', function() {
                    const slider = this.nextElementSibling;
                    if (this.checked) {
                        slider.style.backgroundColor = '#ff9800'; /* Amber/Orange */
                        slider.style.boxShadow = '0 0 1px #ff9800';
                        slider.querySelector(':before').style.transform = 'translateX(28px)';
                    } else {
                        slider.style.backgroundColor = '#2196F3'; /* Blue */
                        slider.style.boxShadow = '0 0 1px #2196F3';
                        slider.querySelector(':before').style.transform = 'translateX(0)';
                    }
                });
            </script>
            
            <div class="text-center text-white relative z-10">
                <div class="logo text-6xl mb-4 inline-block logo-gradient font-amiri">ŸÑŸéÿß ÿ•ŸêŸÑŸ∞ŸáŸé ÿ•ŸêŸÑŸéŸëÿß ÿßŸÑŸÑŸá</div>
                <h1 class="text-4xl sm:text-5xl font-extrabold mb-2 text-shadow-md">Al Bayan</h1>
                <p class="text-lg sm:text-xl font-light opacity-90 max-w-xl mx-auto">‡¶Ü‡¶∞‡¶¨‡¶ø ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡¶ø‡¶ï ‡¶¨‡¶á ‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶</p>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <div class="flex flex-col sm:flex-row bg-white bg-card rounded-xl p-3 mb-8 shadow-xl border border-gray-200 border-light">
            <div class="nav-tab flex-1 text-center p-4 cursor-pointer rounded-xl transition-all duration-300 font-semibold text-gray-600 text-muted active bg-emerald-600 text-white shadow-md hover:bg-emerald-700"
                 onclick="showTab('translate', this)">
                <i class="fas fa-translate mr-2"></i> ‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶ ‡¶ï‡¶∞‡ßÅ‡¶®
            </div>
            <div class="nav-tab flex-1 text-center p-4 cursor-pointer rounded-xl transition-all duration-300 font-semibold text-gray-600 text-muted hover:bg-gray-100 hover:text-gray-800"
                 onclick="showTab('history', this)">
                <i class="fas fa-history mr-2"></i> ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏
            </div>
            <div class="nav-tab flex-1 text-center p-4 cursor-pointer rounded-xl transition-all duration-300 font-semibold text-gray-600 text-muted hover:bg-gray-100 hover:text-gray-800"
                 onclick="showTab('library', this)">
                <i class="fas fa-book mr-2"></i> ‡¶≤‡¶æ‡¶á‡¶¨‡ßç‡¶∞‡ßá‡¶∞‡¶ø
            </div>
        </div>

        <!-- Translation Tab -->
        <div id="translate-tab" class="main-card bg-white bg-card rounded-3xl p-6 md:p-10 shadow-2xl mb-8 border border-gray-200 border-light">
            <!-- API Status -->
            <div id="apiStatus" class="api-status p-3 rounded-xl mb-5 text-center font-semibold bg-yellow-100 text-yellow-800 border-l-4 border-yellow-500 bg-warning">
                <i class="fas fa-exclamation-triangle mr-2"></i> ‡¶ú‡¶ø‡¶Æ‡¶ø‡¶®‡¶ø API ‡¶ü‡¶ø ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®‡•§ ‡¶®‡¶ø‡¶ö‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ API ‡¶ü‡¶ø ‡¶¶‡¶ø‡¶®‡•§
            </div>

            <!-- API Key Input -->
            <div class="bg-gray-100 bg-base p-5 rounded-xl mb-8 border-l-4 border-emerald-600">
                <div class="flex flex-col lg:flex-row gap-4 items-center flex-wrap">
                    <input type="password" id="apiKeyInput" placeholder="‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ú‡¶ø‡¶Æ‡¶ø‡¶®‡¶ø API ‡¶ï‡ßÄ ‡¶¶‡¶ø‡¶®"
                           class="flex-1 p-3 border border-gray-300 rounded-lg font-hind-siliguri min-w-full lg:min-w-0 bg-white bg-card text-base focus:ring-emerald-500 focus:border-emerald-500">
                    <button class="btn btn-primary-gradient text-white px-5 py-3 rounded-full font-semibold shadow-md hover:shadow-lg transition duration-300 flex items-center justify-center w-full lg:w-auto"
                            onclick="saveApiKey()">
                        <i class="fas fa-save mr-2"></i> ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®
                    </button>
                    <button class="btn btn-secondary-gradient text-white px-5 py-3 rounded-full font-semibold shadow-md hover:shadow-lg transition duration-300 flex items-center justify-center w-full lg:w-auto"
                            onclick="testApiKey()">
                        <i class="fas fa-microchip mr-2"></i> ‡¶ü‡ßá‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
                    </button>
                </div>
                <p class="mt-3 text-sm text-gray-500 text-muted">
                    üîë API ‡¶ï‡ßÄ ‡¶™‡¶æ‡¶¨‡ßá‡¶®: <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-emerald-600 hover:text-emerald-800 font-medium">Google AI Studio</a> ‡¶•‡ßá‡¶ï‡ßá
                </p>
            </div>

            <!-- File Upload -->
            <div class="file-upload-container border-4 border-dashed border-emerald-600 rounded-3xl p-10 text-center my-8 bg-upload hover:border-emerald-800 transition duration-300 relative overflow-hidden" id="fileUploadArea">
                <div class="upload-icon text-6xl text-emerald-600 mb-5 drop-shadow-lg">
                    <i class="fas fa-file-pdf"></i>
                </div>
                <h3 class="text-3xl font-bold mb-3 text-gray-800 text-base">PDF ‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
                <p class="text-lg text-gray-500 text-muted mb-6">‡¶Ü‡¶∞‡¶¨‡¶ø ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡¶ø‡¶ï ‡¶¨‡¶á‡¶Ø‡¶º‡ßá‡¶∞ PDF ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶® (‡¶∏‡¶∞‡ßç‡¶¨‡ßã‡¶ö‡ßç‡¶ö ‡ß®‡ß¶ ‡¶è‡¶Æ‡¶¨‡¶ø)</p>
                <input type="file" id="pdfFile" accept=".pdf" hidden>
                <button class="btn btn-gold-gradient text-white px-8 py-4 rounded-full font-bold shadow-xl hover:shadow-2xl transition duration-300"
                        onclick="document.getElementById('pdfFile').click()">
                    <i class="fas fa-upload mr-3"></i> PDF ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
                </button>
            </div>

            <!-- File Info Display -->
            <div id="fileInfo" class="bg-gray-100 bg-base p-4 rounded-xl my-4 border-l-4 border-emerald-600 hidden">
                <div class="file-name font-semibold text-emerald-600" id="fileName"></div>
                <div class="file-size text-gray-500 text-sm text-muted" id="fileSize"></div>
            </div>

            <!-- PDF Type Selection -->
            <div class="bg-yellow-50 bg-warning p-5 rounded-xl my-5 text-center border-l-4 border-yellow-400">
                <strong class="text-gray-800 text-base">üìÑ PDF ‡¶ü‡¶æ‡¶á‡¶™ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®:</strong>
                <div class="flex justify-center gap-5 mt-4 flex-wrap">
                    <div class="pdf-type-option active flex items-center gap-2 p-3 bg-white rounded-lg cursor-pointer transition-all duration-300 shadow-md ring-2 ring-emerald-500"
                         data-type="text" onclick="selectPdfType('text', this)">
                        <i class="fas fa-font text-emerald-600"></i>
                        <span class="text-gray-700">‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£ PDF (‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü)</span>
                    </div>
                    <div class="pdf-type-option flex items-center gap-2 p-3 bg-white rounded-lg cursor-pointer transition-all duration-300 shadow-md hover:ring-2 hover:ring-emerald-500"
                         data-type="ocr" onclick="selectPdfType('ocr', this)">
                        <i class="fas fa-camera text-gray-500"></i>
                        <span class="text-gray-700">‡¶∏‡ßç‡¶ï‡ßç‡¶Ø‡¶æ‡¶® ‡¶ï‡¶∞‡¶æ PDF (OCR)</span>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex justify-center gap-4 my-8 flex-wrap">
                <button class="btn btn-primary-gradient text-white px-8 py-4 rounded-full font-bold shadow-xl hover:shadow-2xl transition duration-300 flex items-center justify-center"
                        onclick="extractAndTranslate()" id="extractTranslateBtn">
                    <i class="fas fa-bolt mr-3"></i> ‡¶è‡¶ï‡¶∏‡¶æ‡¶•‡ßá ‡¶è‡¶ï‡ßç‡¶∏‡¶ü‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶ï‡ßç‡¶ü ‡¶ì ‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶ ‡¶ï‡¶∞‡ßÅ‡¶®
                </button>
                <button class="btn btn-danger-gradient text-white px-8 py-4 rounded-full font-bold shadow-xl hover:shadow-2xl transition duration-300 hidden items-center justify-center"
                        onclick="stopTranslation()" id="stopBtn">
                    <i class="fas fa-stop mr-3"></i> ‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶ ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®
                </button>
                <button class="btn btn-secondary-gradient text-white px-8 py-4 rounded-full font-bold shadow-xl hover:shadow-2xl transition duration-300 flex items-center justify-center"
                        onclick="clearAll()">
                    <i class="fas fa-redo mr-3"></i> ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
                </button>
            </div>

            <!-- Progress Bar -->
            <div class="w-full bg-gray-200 rounded-full my-6 overflow-hidden shadow-inner hidden" id="progressContainer">
                <div class="progress-bar progress-gradient h-6 rounded-full text-center text-white text-sm font-semibold relative"
                     id="progressBar" style="width: 0%">0%</div>
            </div>

            <!-- Loading -->
            <div class="hidden text-center p-10" id="loading">
                <div class="spinner w-16 h-16 border-4 border-gray-300 border-t-emerald-600 rounded-full animate-spin mx-auto mb-4"></div>
                <p id="loadingText" class="text-lg text-gray-500">‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá... ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®</p>
            </div>

            <!-- Text Preview -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 my-10">
                <!-- Arabic Text Preview -->
                <div class="bg-white bg-card rounded-3xl p-6 shadow-xl border border-gray-200 border-light transition duration-300 hover:shadow-2xl">
                    <div class="flex justify-between items-center mb-5 pb-4 border-b-2 border-gray-100 border-light">
                        <h3 class="text-xl font-semibold text-emerald-600 flex items-center gap-3"><i class="fas fa-language"></i> ‡¶Ü‡¶∞‡¶¨‡¶ø ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü</h3>
                        <button class="btn btn-primary-gradient text-white px-4 py-2 rounded-full text-sm font-medium" onclick="openReader('arabic')">
                            <i class="fas fa-expand mr-2"></i> ‡¶¨‡¶°‡¶º ‡¶ï‡¶∞‡ßá ‡¶™‡¶°‡¶º‡ßÅ‡¶®
                        </button>
                    </div>
                    <textarea class="text-content arabic-text w-full h-80 border border-gray-300 rounded-xl p-4 text-lg bg-gray-50 bg-base text-base resize-none focus:ring-emerald-500 focus:border-emerald-500 outline-none transition duration-200"
                              id="arabicText" placeholder="‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶Ü‡¶∞‡¶¨‡¶ø ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶π‡¶¨‡ßá..." readonly></textarea>
                </div>
                <!-- Bangla Translation Preview -->
                <div class="bg-white bg-card rounded-3xl p-6 shadow-xl border border-gray-200 border-light transition duration-300 hover:shadow-2xl">
                    <div class="flex justify-between items-center mb-5 pb-4 border-b-2 border-gray-100 border-light">
                        <h3 class="text-xl font-semibold text-emerald-600 flex items-center gap-3"><i class="fas fa-translate"></i> ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶</h3>
                        <button class="btn btn-primary-gradient text-white px-4 py-2 rounded-full text-sm font-medium" onclick="openReader('bangla')">
                            <i class="fas fa-expand mr-2"></i> ‡¶¨‡¶°‡¶º ‡¶ï‡¶∞‡ßá ‡¶™‡¶°‡¶º‡ßÅ‡¶®
                        </button>
                    </div>
                    <textarea class="text-content bangla-text w-full h-80 border border-gray-300 rounded-xl p-4 text-base bg-gray-50 bg-base text-base resize-none focus:ring-emerald-500 focus:border-emerald-500 outline-none transition duration-200"
                              id="banglaText" placeholder="‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶π‡¶¨‡ßá..." readonly></textarea>
                </div>
            </div>
        </div>

        <!-- History Tab -->
        <div id="history-tab" class="main-card bg-white bg-card rounded-3xl p-6 md:p-10 shadow-2xl mb-8 border border-gray-200 border-light hidden">
            <h2 class="text-center text-2xl md:text-3xl font-bold mb-8 text-emerald-600">
                <i class="fas fa-history mr-2"></i> ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶ ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5 mt-6" id="historyGrid">
                <div class="text-center text-gray-500 p-10 col-span-full">
                    <i class="fas fa-inbox text-5xl mb-4 text-gray-300"></i>
                    <p class="text-lg">‡¶ï‡ßã‡¶®‡ßã ‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶ ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ ‡¶®‡ßá‡¶á</p>
                </div>
            </div>
        </div>

        <!-- Library Tab -->
        <div id="library-tab" class="main-card bg-white bg-card rounded-3xl p-6 md:p-10 shadow-2xl mb-8 border border-gray-200 border-light hidden">
            <h2 class="text-center text-2xl md:text-3xl font-bold mb-8 text-emerald-600">
                <i class="fas fa-book mr-2"></i> ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡¶ø‡¶ï ‡¶≤‡¶æ‡¶á‡¶¨‡ßç‡¶∞‡ßá‡¶∞‡¶ø
            </h2>
            <div class="text-center text-gray-500 p-10 bg-gray-50 bg-base rounded-xl">
                <i class="fas fa-hourglass-half text-5xl mb-4 text-emerald-300"></i>
                <p class="text-xl">‡¶∂‡ßÄ‡¶ò‡ßç‡¶∞‡¶á ‡¶Ü‡¶∏‡¶õ‡ßá... ‡¶™‡ßç‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡¶ø‡¶ï ‡¶¨‡¶á‡¶ó‡ßÅ‡¶≤‡ßã‡¶∞ ‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π</p>
            </div>
        </div>
    </div>

    <!-- Reader Modal -->
    <div class="reader-modal hidden fixed inset-0 bg-black bg-opacity-80 backdrop-blur-lg z-50 flex items-center justify-center transition-opacity duration-300" id="readerModal">
        <div class="reader-content relative w-11/12 h-5/6 bg-white bg-card rounded-3xl shadow-2xl flex flex-col overflow-hidden">
            <div class="reader-header flex justify-between items-center p-5 bg-emerald-600 text-white">
                <h3 id="readerTitle" class="text-2xl font-bold">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶</h3>
                <button class="btn px-4 py-2 rounded-full bg-white bg-opacity-20 hover:bg-opacity-30 transition duration-200 text-sm font-medium" onclick="closeReader()">
                    <i class="fas fa-times mr-2"></i> ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®
                </button>
            </div>
            <div class="reader-body flex-1 p-8 overflow-y-auto text-lg text-base" id="readerBody">
                <div class="reader-content-text bangla-text text-xl leading-relaxed"></div>
            </div>
            <div class="reader-controls p-5 bg-gray-100 bg-base border-t border-gray-200 border-light flex gap-4 items-center justify-center flex-wrap">
                <button class="btn btn-primary-gradient px-4 py-2 rounded-full text-sm font-medium" onclick="changeFontSize(-2)">
                    <i class="fas fa-font mr-2"></i> ‡¶õ‡ßã‡¶ü
                </button>
                <button class="btn btn-primary-gradient px-4 py-2 rounded-full text-sm font-medium" onclick="changeFontSize(2)">
                    <i class="fas fa-font mr-2"></i> ‡¶¨‡¶°‡¶º
                </button>
                <button class="btn btn-secondary-gradient px-4 py-2 rounded-full text-sm font-medium" onclick="toggleDarkReader()">
                    <i class="fas fa-moon mr-2"></i> ‡¶®‡¶æ‡¶á‡¶ü ‡¶Æ‡ßã‡¶°
                </button>
                <button class="btn btn-danger-gradient px-4 py-2 rounded-full text-sm font-medium transition duration-300" id="ttsButton" onclick="toggleSpeakText()">
                    <i class="fas fa-volume-up mr-2"></i> ‡¶™‡¶°‡¶º‡ßÅ‡¶®
                </button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="text-center p-8 text-gray-500 border-t border-gray-200 border-light mt-10 text-muted">
        <p class="text-sm">¬© 2025 Al-Bayan - Translation is powered by Google Gemini and should be read carefully.
        </p>
        <p class="mt-2 text-xs">
            ‡¶¨‡¶æ‡¶ï‡¶ø‡¶Ø‡¶º‡¶æ‡¶π ‡¶á‡¶®‡¶∏‡ßç‡¶ü‡¶ø‡¶ü‡¶ø‡¶â‡¶ü ‡¶¶‡ßç‡¶¨‡¶æ‡¶∞‡¶æ ‡¶™‡¶∞‡¶ø‡¶ö‡¶æ‡¶≤‡¶ø‡¶§
        </p>
    </footer>

    <script>
        // Global variables
        let extractedText = '';
        let selectedPdfType = 'text';
        let tesseractWorker = null;
        let currentFile = null;
        let isSpeaking = false;
        let speechSynthesis = window.speechSynthesis;
        let GEMINI_API_KEY = '';
        let isTranslationRunning = false;
        let currentTranslationProcess = null;

        // Gemini API Configuration
        const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent";
        
        // --- Custom Notification System (Replaces alert()) ---

        function showNotification(message, type = 'success') {
            const container = document.getElementById('notificationContainer');
            const id = Date.now();
            const colorMap = {
                success: 'bg-emerald-100 border-l-4 border-emerald-500 text-emerald-700',
                warning: 'bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700',
                error: 'bg-red-100 border-l-4 border-red-500 text-red-700',
                info: 'bg-blue-100 border-l-4 border-blue-500 text-blue-700'
            };
            const iconMap = {
                success: 'fas fa-check-circle',
                warning: 'fas fa-exclamation-triangle',
                error: 'fas fa-times-circle',
                info: 'fas fa-info-circle'
            };

            const notification = document.createElement('div');
            notification.id = `notif-${id}`;
            notification.className = `p-4 rounded-lg shadow-lg max-w-sm w-full opacity-0 transition-opacity duration-500 ${colorMap[type]}`;
            notification.innerHTML = `
                <div class="flex items-start">
                    <i class="${iconMap[type]} mt-1 mr-3 text-lg"></i>
                    <p class="text-sm font-medium flex-1">${message}</p>
                    <button class="ml-auto -mt-1 text-lg opacity-75 hover:opacity-100" onclick="document.getElementById('notif-${id}').remove()">
                        &times;
                    </button>
                </div>
            `;
            
            container.appendChild(notification);
            
            // Fade in
            setTimeout(() => notification.style.opacity = '1', 10);

            // Fade out and remove after 5 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 500);
            }, 5000);
        }

        const showSuccess = (msg) => showNotification(`‚úÖ ${msg}`, 'success');
        const showWarning = (msg) => showNotification(`‚ö†Ô∏è ${msg}`, 'warning');
        const showError = (msg) => showNotification(`‚ùå ${msg}`, 'error');
        
        // --- End Custom Notification System ---

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeTheme();
            loadApiKey();
            setupEventListeners();
            loadHistory();
        });

        // Load API Key from localStorage
        function loadApiKey() {
            const savedKey = localStorage.getItem('gemini_api_key');
            if (savedKey) {
                GEMINI_API_KEY = savedKey;
                document.getElementById('apiKeyInput').value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                updateApiStatus('success', '‚úÖ API ‡¶ü‡¶ø ‡¶≤‡ßã‡¶° ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá! ‡¶Ü‡¶™‡¶®‡¶ø ‡¶è‡¶ñ‡¶® ‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶ ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®‡•§');
            }
        }

        // Save API Key
        function saveApiKey() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            
            if (!apiKey || apiKey === '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢') {
                if (!GEMINI_API_KEY) {
                    showWarning('‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶¨‡ßà‡¶ß API ‡¶ï‡ßÄ ‡¶¶‡¶ø‡¶®‡•§');
                }
                return;
            }

            GEMINI_API_KEY = apiKey;
            localStorage.setItem('gemini_api_key', apiKey);
            document.getElementById('apiKeyInput').value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
            updateApiStatus('success', '‚úÖ API ‡¶ü‡¶ø ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá! ‡¶Ü‡¶™‡¶®‡¶ø ‡¶è‡¶ñ‡¶® ‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶ ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®‡•§');
        }

        // Test API Key
        async function testApiKey() {
            const apiKeyInput = document.getElementById('apiKeyInput');
            const apiKey = apiKeyInput.value.trim();
            const originalKey = GEMINI_API_KEY;

            if (!apiKey || apiKey === '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢') {
                if (!originalKey) {
                    showWarning('‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶è‡¶ï‡¶ü‡¶ø API ‡¶ï‡ßÄ ‡¶¶‡¶ø‡¶®‡•§');
                    return;
                }
            } else {
                GEMINI_API_KEY = apiKey;
                // Temporarily save for the test
            }

            showLoading('API ‡¶ï‡ßÄ ‡¶ü‡ßá‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...');

            try {
                // Using a small, known Arabic phrase for a quick test
                const testResult = await translateWithGemini('ÿ≥ŸÑÿßŸÖ ÿπŸÑŸäŸÉŸÖ', true);
                if (testResult.includes('API_ERROR')) {
                    throw new Error('API ‡¶ï‡ßÄ‡¶ü‡¶ø ‡¶¨‡ßà‡¶ß ‡¶®‡¶Ø‡¶º ‡¶Ö‡¶•‡¶¨‡¶æ ‡¶∞‡ßá‡¶ü ‡¶∏‡ßÄ‡¶Æ‡¶ø‡¶§‡•§');
                }
                updateApiStatus('success', '‚úÖ API ‡¶ü‡¶ø ‡¶∏‡¶†‡¶ø‡¶ï! ‡¶Ü‡¶™‡¶®‡¶ø ‡¶è‡¶ñ‡¶® ‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶ ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®‡•§');
                if (apiKey && apiKey !== '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢') {
                     localStorage.setItem('gemini_api_key', GEMINI_API_KEY);
                }
            } catch (error) {
                updateApiStatus('error', '‚ùå API ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: ' + error.message);
                GEMINI_API_KEY = originalKey; // Revert if test fails
            } finally {
                hideLoading();
                if (GEMINI_API_KEY) {
                    apiKeyInput.value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                }
            }
        }

        // Update API Status
        function updateApiStatus(type, message) {
            const statusDiv = document.getElementById('apiStatus');
            const baseClasses = 'api-status p-3 rounded-xl mb-5 text-center font-semibold';
            
            let classes = '';
            if (type === 'success') {
                classes = 'bg-green-100 text-green-800 border-l-4 border-green-500 bg-success';
            } else if (type === 'error') {
                classes = 'bg-red-100 text-red-800 border-l-4 border-red-500';
            } else {
                classes = 'bg-yellow-100 text-yellow-800 border-l-4 border-yellow-500 bg-warning';
            }

            statusDiv.className = `${baseClasses} ${classes}`;
            statusDiv.innerHTML = `<i class="${type === 'success' ? 'fas fa-check-circle' : type === 'error' ? 'fas fa-times-circle' : 'fas fa-exclamation-triangle'} mr-2"></i> ${message}`;
        }

        // Theme functionality
        function initializeTheme() {
            const themeToggle = document.getElementById('themeToggle');
            const savedTheme = localStorage.getItem('theme') || 'light';
            
            if (savedTheme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
                themeToggle.checked = true;
                // Manually apply slider style for initial load
                const slider = themeToggle.nextElementSibling;
                slider.style.backgroundColor = '#ff9800';
                slider.querySelector(':before').style.transform = 'translateX(28px)';
            }
            
            themeToggle.addEventListener('change', function() {
                if (this.checked) {
                    document.documentElement.setAttribute('data-theme', 'dark');
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.documentElement.setAttribute('data-theme', 'light');
                    localStorage.setItem('theme', 'light');
                }
            });
        }

        // Event listeners
        function setupEventListeners() {
            // File upload handling
            document.getElementById('pdfFile').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;

                currentFile = file;
                displayFileInfo(file);
            });
            
            // Drag and drop support
            const dropArea = document.getElementById('fileUploadArea');
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults (e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, () => dropArea.classList.add('ring-4', 'ring-emerald-500'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, () => dropArea.classList.remove('ring-4', 'ring-emerald-500'), false);
            });

            dropArea.addEventListener('drop', handleDrop, false);

            function handleDrop(e) {
                let dt = e.dataTransfer;
                let files = dt.files;
                if (files.length > 0) {
                    const file = files[0];
                    if (file.type === 'application/pdf') {
                        currentFile = file;
                        document.getElementById('pdfFile').files = files; // Sync the input element
                        displayFileInfo(file);
                    } else {
                        showError('‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶è‡¶ï‡¶ü‡¶ø PDF ‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
                    }
                }
            }
        }

        // Display file information
        function displayFileInfo(file) {
            const fileInfo = document.getElementById('fileInfo');
            const fileName = document.getElementById('fileName');
            const fileSize = document.getElementById('fileSize');
            
            const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
            
            fileName.textContent = file.name;
            fileSize.textContent = `‡¶Ü‡¶ï‡¶æ‡¶∞: ${fileSizeMB} MB`;
            fileInfo.classList.remove('hidden');

            // Show warning for large files
            if (file.size > 10 * 1024 * 1024) {
                showWarning(`‡¶¨‡¶°‡¶º ‡¶´‡¶æ‡¶á‡¶≤ (${fileSizeMB} MB): ‡¶™‡ßç‡¶∞‡¶∏‡ßá‡¶∏‡¶ø‡¶Ç ‡¶¨‡ßá‡¶∂‡¶ø ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶®‡¶ø‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡•§ OCR ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡ßß‡ß¶ MB ‡¶è‡¶∞ ‡¶®‡¶ø‡¶ö‡ßá ‡¶•‡¶æ‡¶ï‡¶æ ‡¶≠‡¶æ‡¶≤‡ßã‡•§`);
            }
        }

        // PDF type selection
        function selectPdfType(type, element) {
            selectedPdfType = type;
            document.querySelectorAll('.pdf-type-option').forEach(opt => {
                opt.classList.remove('active', 'ring-2', 'ring-emerald-500', 'shadow-lg');
                opt.querySelector('i').classList.remove('text-emerald-600');
                opt.querySelector('i').classList.add('text-gray-500');
            });
            element.classList.add('active', 'ring-2', 'ring-emerald-500', 'shadow-lg');
            element.querySelector('i').classList.add('text-emerald-600');
            element.querySelector('i').classList.remove('text-gray-500');

            if(type === 'ocr' && currentFile && currentFile.size > 10 * 1024 * 1024) {
                showWarning('‚ö†Ô∏è ‡¶∏‡ßç‡¶ï‡ßç‡¶Ø‡¶æ‡¶® ‡¶ï‡¶∞‡¶æ PDF (OCR) ‡¶ñ‡ßÅ‡¶¨‡¶á ‡¶ß‡ßÄ‡¶∞ ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ, ‡¶¨‡¶ø‡¶∂‡ßá‡¶∑ ‡¶ï‡¶∞‡ßá ‡¶¨‡¶°‡¶º ‡¶´‡¶æ‡¶á‡¶≤‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø (‡ßß‡ß¶+ MB)‡•§ ‡¶Ö‡¶≤‡ßç‡¶™ ‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ ‡¶®‡¶ø‡¶Ø‡¶º‡ßá ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
            }
        }

        // Stop translation function
        function stopTranslation() {
            if (isTranslationRunning) {
                isTranslationRunning = false;
                document.getElementById('stopBtn').classList.add('hidden');
                document.getElementById('extractTranslateBtn').disabled = false;
                hideLoading();
                document.getElementById('progressContainer').classList.add('hidden');
                showWarning('‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶ ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!');
                
                // Clean up Tesseract worker if it exists
                if (tesseractWorker) {
                    tesseractWorker.terminate();
                    tesseractWorker = null;
                }
            }
        }

        // Main translation function
        async function extractAndTranslate() {
            if (!currentFile) {
                showError('‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶è‡¶ï‡¶ü‡¶ø PDF ‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
                return;
            }

            if (!GEMINI_API_KEY) {
                showError('‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶¨‡ßà‡¶ß ‡¶ú‡¶ø‡¶Æ‡¶ø‡¶®‡¶ø API ‡¶ï‡ßÄ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
                document.getElementById('apiKeyInput').focus();
                return;
            }

            // File size validation
            if (currentFile.size > 20 * 1024 * 1024) {
                showError('‡¶´‡¶æ‡¶á‡¶≤ ‡¶ñ‡ßÅ‡¶¨ ‡¶¨‡¶°‡¶º! ‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá ‡ß®‡ß¶ ‡¶è‡¶Æ‡¶¨‡¶ø-‡¶è‡¶∞ ‡¶õ‡ßã‡¶ü ‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
                return;
            }

            const extractTranslateBtn = document.getElementById('extractTranslateBtn');
            extractTranslateBtn.disabled = true;
            document.getElementById('stopBtn').classList.remove('hidden');
            isTranslationRunning = true;

            try {
                // Clear previous text
                document.getElementById('arabicText').value = '';
                document.getElementById('banglaText').value = '';

                showLoading('PDF ‡¶™‡ßç‡¶∞‡¶∏‡ßá‡¶∏ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...');
                
                if (selectedPdfType === 'ocr') {
                    await extractWithOCRAndTranslate(currentFile);
                } else {
                    await extractNormalAndTranslate(currentFile);
                }
                
                if (isTranslationRunning) {
                    // Save to history only if not stopped
                    saveToHistory();
                }
                
            } catch (error) {
                if (isTranslationRunning) {
                    console.error('Translation error:', error);
                    showError('‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: ' + (error.message || '‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶ ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá'));
                }
            } finally {
                if (isTranslationRunning) {
                    extractTranslateBtn.disabled = false;
                    document.getElementById('stopBtn').classList.add('hidden');
                    hideLoading();
                    isTranslationRunning = false;
                }
            }
        }

        // Normal PDF extraction with translation
        async function extractNormalAndTranslate(file) {
            try {
                const pdf = await pdfjsLib.getDocument(await file.arrayBuffer()).promise;
                const maxPages = 400; // Limit pages to prevent memory issues
                const totalPages = Math.min(pdf.numPages, maxPages);
                let arabicText = '';
                let banglaTranslation = '';

                document.getElementById('progressContainer').classList.remove('hidden');

                for (let i = 1; i <= totalPages; i++) {
                    if (!isTranslationRunning) { return; }

                    showLoading(`‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ ${i}/${totalPages} (‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü) ‡¶™‡ßç‡¶∞‡¶∏‡ßá‡¶∏ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...`);
                    
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    const pageText = content.items.map(item => item.str).join(' ');
                    
                    if (pageText.trim().length > 0) {
                        arabicText += `\n\n--- ‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ ${i} ---\n${pageText}`;
                        document.getElementById('arabicText').value = arabicText;

                        // Translate in chunks (simulate API call with delay/backoff)
                        showLoading(`‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ ${i}/${totalPages} ‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...`);
                        const translatedText = await translateWithGemini(pageText);
                        
                        // Append and scroll to bottom
                        banglaTranslation += `\n\n--- ‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ ${i} ---\n${translatedText}`;
                        document.getElementById('banglaText').value = banglaTranslation;
                        document.getElementById('banglaText').scrollTop = document.getElementById('banglaText').scrollHeight;
                        document.getElementById('arabicText').scrollTop = document.getElementById('arabicText').scrollHeight;
                    }

                    const progress = Math.round((i / totalPages) * 100);
                    updateProgress(progress);

                    await delay(1500); // Wait between API calls to prevent aggressive rate limiting
                }

                if (isTranslationRunning) {
                    extractedText = arabicText;
                    document.getElementById('progressContainer').classList.add('hidden');
                    showSuccess(`${totalPages} ‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!`);
                }

            } catch (error) {
                if (isTranslationRunning) {
                    throw new Error('PDF ‡¶™‡¶°‡¶º‡¶§‡ßá ‡¶¨‡¶æ ‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶ ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: ' + error.message);
                }
            }
        }

        // OCR extraction with translation
        async function extractWithOCRAndTranslate(file) {
            showLoading('OCR ‡¶á‡¶û‡ßç‡¶ú‡¶ø‡¶® ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡ßÅ‡¶§ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...');
            
            try {
                if (!tesseractWorker) {
                    tesseractWorker = await Tesseract.createWorker('ara');
                }

                const pdf = await pdfjsLib.getDocument(await file.arrayBuffer()).promise;
                const maxPages = 10; // Hard limit for OCR due to high resource usage
                const totalPages = Math.min(pdf.numPages, maxPages);
                let arabicText = '';
                let banglaTranslation = '';

                document.getElementById('progressContainer').classList.remove('hidden');

                for (let i = 1; i <= totalPages; i++) {
                    if (!isTranslationRunning) { return; }

                    showLoading(`‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ ${i}/${totalPages} (OCR) ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá... ‡¶è‡¶ü‡¶ø ‡¶∏‡¶Æ‡¶Ø‡¶º‡¶∏‡¶æ‡¶™‡ßá‡¶ï‡ßç‡¶∑...`);
                    
                    const page = await pdf.getPage(i);
                    const viewport = page.getViewport({ scale: 2.0 }); // Increased scale for better OCR accuracy
                    
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    
                    await page.render({
                        canvasContext: context,
                        viewport: viewport
                    }).promise;

                    // Tesseract OCR
                    const { data: { text } } = await tesseractWorker.recognize(canvas);
                    
                    if (text.trim().length > 0) {
                        arabicText += `\n\n--- ‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ ${i} ---\n${text}`;
                        document.getElementById('arabicText').value = arabicText;

                        // Translate the OCR text
                        showLoading(`‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ ${i}/${totalPages} ‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...`);
                        const translatedText = await translateWithGemini(text);
                        
                        // Append and scroll to bottom
                        banglaTranslation += `\n\n--- ‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ ${i} ---\n${translatedText}`;
                        document.getElementById('banglaText').value = banglaTranslation;
                        document.getElementById('banglaText').scrollTop = document.getElementById('banglaText').scrollHeight;
                        document.getElementById('arabicText').scrollTop = document.getElementById('arabicText').scrollHeight;
                    }

                    const progress = Math.round((i / totalPages) * 100);
                    updateProgress(progress);

                    await delay(2500); // Longer delay for OCR to API sequence
                }

                if (isTranslationRunning) {
                    extractedText = arabicText;
                    document.getElementById('progressContainer').classList.add('hidden');
                    showSuccess(`${totalPages} ‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ OCR ‡¶è‡¶¨‡¶Ç ‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶ ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£!`);
                }
                
                // Terminate worker after use
                if (tesseractWorker) {
                    await tesseractWorker.terminate();
                    tesseractWorker = null;
                }

            } catch (error) {
                if (isTranslationRunning) {
                    if (tesseractWorker) {
                        await tesseractWorker.terminate();
                        tesseractWorker = null;
                    }
                    throw new Error('OCR ‡¶¨‡¶æ ‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶ ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: ' + error.message);
                }
            }
        }
        
        // Real Gemini API translation with Exponential Backoff
        async function translateWithGemini(text, isTest = false) {
            if (!GEMINI_API_KEY) {
                throw new Error('API ‡¶ï‡ßÄ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§ ‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá API ‡¶ï‡ßÄ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
            }
            if (!isTranslationRunning && !isTest) {
                return "‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶ ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá";
            }
            
            const maxRetries = 5;
            let attempt = 0;
            const truncatedText = text.substring(0, 3000); // Keep prompt small

            while (attempt < maxRetries) {
                try {
                    const apiUrl = `${GEMINI_API_URL}?key=${GEMINI_API_KEY}`;
                    
                    const requestBody = {
                        contents: [{
                            parts: [{
                                text: `Translate this Arabic Islamic text to natural Bangla accurately. Preserve religious meaning and Islamic terminology (like Allah, Prophet, Hadith, etc.). Maintain the original formatting (paragraphs, lists) as much as possible. Keep the translation concise, natural, and highly accurate. Only return the translated text, no additional comments or introductions.

                                Arabic Text: ${truncatedText}`
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.3,
                            topK: 40,
                            topP: 0.8,
                            maxOutputTokens: 2048,
                        },
                         // Enforce the use of the latest stable model
                        model: "gemini-2.5-flash"
                    };

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestBody)
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        const errorMessage = data.error?.message || `API Error: ${response.status}`;
                        // Check for rate limit (429) or temporary server errors (500/503)
                        if (response.status === 429 || response.status >= 500) {
                            console.warn(`API attempt ${attempt + 1} failed with status ${response.status}. Retrying...`);
                            throw new Error(errorMessage); // Throw to trigger backoff
                        } else {
                            // Non-retryable error (e.g., 400 Bad Request, Invalid API Key)
                            if (isTest) return 'API_ERROR: ' + errorMessage;
                            throw new Error(errorMessage);
                        }
                    }
                    
                    const translatedText = data.candidates?.[0]?.content?.parts?.[0]?.text || "‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶∏‡¶Æ‡ßü ‡¶ï‡ßã‡¶®‡ßã ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§";
                    
                    if (isTest) {
                        return 'API_TEST_SUCCESS';
                    }
                    
                    return translatedText;

                } catch (error) {
                    attempt++;
                    if (attempt >= maxRetries) {
                        if (isTest) return 'API_ERROR: Max retries exceeded: ' + error.message;
                        throw new Error(`‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶ ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•: API ‡¶∏‡¶∞‡ßç‡¶¨‡ßã‡¶ö‡ßç‡¶ö ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶ï‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶™‡¶∞‡ßá‡¶ì ‡¶∏‡¶æ‡¶°‡¶º‡¶æ ‡¶¶‡ßá‡¶Ø‡¶º‡¶®‡¶ø‡•§ ${error.message}`);
                    }
                    const delayTime = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                    await delay(delayTime);
                }
            }
        }


        // Utility functions
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function showLoading(message) {
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('loadingText').textContent = message;
        }

        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }

        function updateProgress(percent) {
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressBar').textContent = percent + '%';
        }

        // Tab navigation
        function showTab(tabName, element) {
            document.querySelectorAll('.main-card').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active', 'bg-emerald-600', 'text-white', 'shadow-md', 'hover:bg-emerald-700');
                tab.classList.add('text-gray-600', 'hover:bg-gray-100', 'hover:text-gray-800');
            });
            
            document.getElementById(tabName + '-tab').classList.remove('hidden');
            element.classList.add('active', 'bg-emerald-600', 'text-white', 'shadow-md');
            element.classList.remove('text-gray-600', 'hover:bg-gray-100', 'hover:text-gray-800');

            // Load history only when history tab is clicked
            if (tabName === 'history') {
                loadHistory();
            }
        }

        // Reader functionality
        function openReader(type) {
            const modal = document.getElementById('readerModal');
            const title = document.getElementById('readerTitle');
            const contentDiv = modal.querySelector('.reader-content-text');
            const readerBody = document.getElementById('readerBody');
            
            let content = '';
            
            if (type === 'arabic') {
                title.textContent = '‡¶Ü‡¶∞‡¶¨‡¶ø ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü';
                content = document.getElementById('arabicText').value || '‡¶ï‡ßã‡¶®‡ßã ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶®‡ßá‡¶á';
                contentDiv.className = 'reader-content-text arabic-text text-3xl leading-relaxed';
                contentDiv.textContent = content;
            } else {
                title.textContent = '‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶';
                content = document.getElementById('banglaText').value || '‡¶ï‡ßã‡¶®‡ßã ‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶ ‡¶®‡ßá‡¶á';
                contentDiv.className = 'reader-content-text bangla-text text-xl leading-relaxed';
                contentDiv.textContent = content;
            }
            
            modal.classList.remove('hidden');
            
            // Reset reader theme to match global theme
            if (document.documentElement.getAttribute('data-theme') === 'dark') {
                readerBody.classList.add('bg-gray-800', 'text-gray-200');
            } else {
                readerBody.classList.remove('bg-gray-800', 'text-gray-200');
            }

            // Stop any ongoing speech when opening reader
            stopSpeech();
        }

        function closeReader() {
            stopSpeech();
            document.getElementById('readerModal').classList.add('hidden');
        }

        function changeFontSize(delta) {
            const contentDiv = document.getElementById('readerModal').querySelector('.reader-content-text');
            const currentSize = parseInt(window.getComputedStyle(contentDiv).fontSize);
            const newSize = Math.max(16, Math.min(50, currentSize + delta));
            contentDiv.style.fontSize = newSize + 'px';
        }

        function toggleDarkReader() {
            const body = document.getElementById('readerBody');
            const toggleButton = document.getElementById('readerModal').querySelector('.reader-controls button:nth-child(3)');
            const isDark = body.classList.contains('bg-gray-800');
            
            if (isDark) {
                body.classList.remove('bg-gray-800', 'text-gray-200');
                body.classList.add('bg-white', 'text-gray-800');
                toggleButton.innerHTML = '<i class="fas fa-moon mr-2"></i> ‡¶®‡¶æ‡¶á‡¶ü ‡¶Æ‡ßã‡¶°';
            } else {
                body.classList.add('bg-gray-800', 'text-gray-200');
                body.classList.remove('bg-white', 'text-gray-800');
                toggleButton.innerHTML = '<i class="fas fa-sun mr-2"></i> ‡¶°‡ßá ‡¶Æ‡ßã‡¶°';
            }
        }

        // Text-to-speech with toggle functionality (using native browser TTS)
        function toggleSpeakText() {
            if (isSpeaking) {
                stopSpeech();
            } else {
                speakText();
            }
        }

        function speakText() {
            const text = document.getElementById('readerModal').querySelector('.reader-content-text').textContent;
            const language = document.getElementById('readerTitle').textContent.includes('‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ') ? 'bn-BD' : 'ar-SA';
            
            if (!text || text.includes('‡¶®‡ßá‡¶á')) {
                showWarning('‡¶™‡¶°‡¶º‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡ßã‡¶®‡ßã ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶®‡ßá‡¶á‡•§');
                return;
            }

            if ('speechSynthesis' in window) {
                stopSpeech(); // Stop any ongoing speech first
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = language;
                utterance.rate = 0.8;
                utterance.pitch = 1;
                
                // Update button state
                isSpeaking = true;
                const ttsButton = document.getElementById('ttsButton');
                ttsButton.innerHTML = '<i class="fas fa-stop mr-2"></i> ‡¶•‡¶æ‡¶Æ‡ßÅ‡¶®';
                ttsButton.classList.add('tts-active');
                
                // Handle speech end
                utterance.onend = function() {
                    stopSpeech();
                };
                
                // Handle speech error
                utterance.onerror = function(e) {
                    console.error('TTS Error:', e);
                    stopSpeech();
                    showError('Text-to-speech ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§');
                };
                
                speechSynthesis.speak(utterance);
            } else {
                showError('‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶∞‡¶æ‡¶â‡¶ú‡¶æ‡¶∞‡ßá Text-to-speech ‡¶∏‡¶Æ‡¶∞‡ßç‡¶•‡¶ø‡¶§ ‡¶®‡¶Ø‡¶º‡•§');
            }
        }

        function stopSpeech() {
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
            }
            isSpeaking = false;
            const ttsButton = document.getElementById('ttsButton');
            ttsButton.innerHTML = '<i class="fas fa-volume-up mr-2"></i> ‡¶™‡¶°‡¶º‡ßÅ‡¶®';
            ttsButton.classList.remove('tts-active');
        }

        // History functionality (Uses localStorage - limited storage for full text)
        function saveToHistory() {
            const fullArabicText = document.getElementById('arabicText').value;
            const fullBanglaText = document.getElementById('banglaText').value;

            if (fullBanglaText.trim().length === 0) return;

            const history = JSON.parse(localStorage.getItem('translationHistory') || '[]');
            const newItem = {
                id: Date.now(),
                title: currentFile?.name || '‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶',
                // Store only a preview of the text due to localStorage size limitations
                arabicText: fullArabicText.substring(0, 500) + (fullArabicText.length > 500 ? '...' : ''),
                banglaText: fullBanglaText.substring(0, 500) + (fullBanglaText.length > 500 ? '...' : ''),
                date: new Date().toLocaleDateString('bn-BD', { day: '2-digit', month: 'short', year: 'numeric' })
            };
            
            history.unshift(newItem);
            // Keep history limited to 10 items
            if (history.length > 10) history.pop(); 
            localStorage.setItem('translationHistory', JSON.stringify(history));
            loadHistory();
        }

        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('translationHistory') || '[]');
            const historyGrid = document.getElementById('historyGrid');
            
            if (history.length === 0) {
                historyGrid.innerHTML = `
                    <div class="text-center text-gray-500 p-10 col-span-full">
                        <i class="fas fa-inbox text-5xl mb-4 text-gray-300"></i>
                        <p class="text-lg">‡¶ï‡ßã‡¶®‡ßã ‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶ ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ ‡¶®‡ßá‡¶á</p>
                    </div>
                `;
                return;
            }

            historyGrid.innerHTML = history.map(item => `
                <div class="history-card bg-white bg-card rounded-xl p-5 shadow-lg border border-gray-200 border-light transition duration-300 cursor-pointer hover:shadow-xl hover:translate-y-[-3px]" onclick="loadHistoryItem(${item.id})">
                    <div class="flex justify-between items-start mb-3 border-b pb-2 border-gray-100 border-light">
                        <div class="history-title font-bold text-gray-800 text-base text-lg truncate">${item.title}</div>
                        <div class="history-date text-gray-500 text-sm whitespace-nowrap ml-4 text-muted">${item.date}</div>
                    </div>
                    <p class="history-preview text-gray-600 text-sm line-clamp-3 text-muted">${item.banglaText}</p>
                    <p class="text-xs text-emerald-600 mt-2 font-medium">‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®</p>
                </div>
            `).join('');
        }

        function loadHistoryItem(id) {
            const history = JSON.parse(localStorage.getItem('translationHistory') || '[]');
            const item = history.find(h => h.id === id);
            
            if (item) {
                // Warning: Since we only store a preview, we warn the user. 
                // In a real app, you would fetch the full text from Firestore/backend.
                document.getElementById('arabicText').value = `[‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ ‡¶≤‡ßã‡¶°] ${item.arabicText}\n\n--- ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶Ö‡¶Ç‡¶∂ ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø (‡¶°‡ßá‡¶Æ‡ßã ‡¶∏‡ßÄ‡¶Æ‡¶æ‡¶¨‡¶¶‡ßç‡¶ß‡¶§‡¶æ) ---`;
                document.getElementById('banglaText').value = `[‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ ‡¶≤‡ßã‡¶°] ${item.banglaText}\n\n--- ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶Ö‡¶Ç‡¶∂ ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø (‡¶°‡ßá‡¶Æ‡ßã ‡¶∏‡ßÄ‡¶Æ‡¶æ‡¶¨‡¶¶‡ßç‡¶ß‡¶§‡¶æ) ---`;
                
                // Manually trigger tab switch
                document.querySelectorAll('.nav-tab')[0].click(); 
                showNotification('‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ ‡¶•‡ßá‡¶ï‡ßá ‡¶™‡ßç‡¶∞‡¶ø‡¶≠‡¶ø‡¶â ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶¶‡ßá‡¶ñ‡¶§‡ßá, ‡¶´‡¶æ‡¶á‡¶≤‡¶ü‡¶ø ‡¶™‡ßÅ‡¶®‡¶∞‡¶æ‡¶Ø‡¶º ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®‡•§', 'info');
            }
        }

        // Clear all function
        function clearAll() {
            stopTranslation();
            
            document.getElementById('pdfFile').value = '';
            document.getElementById('arabicText').value = '';
            document.getElementById('banglaText').value = '';
            document.getElementById('fileInfo').classList.add('hidden');
            document.getElementById('progressContainer').classList.add('hidden');
            document.getElementById('extractTranslateBtn').disabled = false;
            document.getElementById('stopBtn').classList.add('hidden');

            currentFile = null;
            extractedText = '';
            
            // Stop any ongoing speech
            stopSpeech();
            
            showNotification('‡¶∏‡¶¨ ‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§', 'info');
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('readerModal');
            if (event.target === modal) {
                closeReader();
            }
        }

        // Stop speech when page is hidden
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                stopSpeech();
            }
        });
    </script>
</body>
</html>
